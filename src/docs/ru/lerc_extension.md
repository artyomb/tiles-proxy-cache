# LERC Extension для Ruby

## Обзор

`lerc_extension.cpp` — это Ruby C++ расширение, которое обеспечивает конвертацию данных LERC (Limited Error Raster Compression) в формат Mapbox Terrain-RGB PNG. Расширение интегрировано в сервис кэширования тайлов и используется для обработки данных рельефа, получаемых от ArcGIS сервисов.

## Назначение

### Проблема
ArcGIS сервисы предоставляют данные рельефа в формате LERC — специализированном формате сжатия растровых данных с контролируемой погрешностью. Для использования в веб-приложениях эти данные необходимо конвертировать в стандартный формат PNG с кодированием высот в RGB-каналах.

### Решение
Расширение выполняет декодирование LERC-данных и преобразует их в Mapbox Terrain-RGB формат, где:
- Высота кодируется в 24-битном RGB значении
- Результат сохраняется как PNG изображение

#### Формулы кодирования и декодирования

**Декодирование (RGB → высота в метрах):**
```
height = -10000 + ((R × 256²) + (G × 256) + B) × 0.1
```
где R, G, B — значения каналов в диапазоне 0…255

**Кодирование (высота h в м → R,G,B):**

1. Высота h должна попадать в диапазон, представимый 24-битным числом после сдвига (диапазон, соответствующий смещению −10000 м и шагу 0.1 м; кодовое значение должно быть в пределах 0…16777215)

2. Вычисляется целочисленный код:
```
code = round((h + 10000) / 0.1) = round((h + 10000) × 10)
```

3. Код разлагается на байты:
```
R = floor(code / 256²)
G = floor((code - R × 256²) / 256)
B = code - R × 256² - G × 256
```

**Константы:**
- `MAPBOX_OFFSET = 10000.0` - смещение для отрицательных высот
- `MAPBOX_SCALE = 0.1` - масштабирующий коэффициент (точность 0.1 метра)
- `MAX_24BIT = 16777215` - максимальное 24-битное значение (2^24 - 1)

**Диапазон высот:** от -10,000 до +16,777,215 метров

## Технические детали

### Используемые библиотеки

#### LERC (Esri)
[LERC](https://github.com/Esri/lerc) — это открытая библиотека для сжатия растровых данных с контролируемой погрешностью. Основные характеристики:

- Поддерживает различные типы данных (int, float, double)
- Позволяет задавать максимальную погрешность на пиксель
- Обеспечивает высокую скорость кодирования/декодирования
- Работает с масками валидных пикселей
- Поддерживает многоканальные данные

В проекте используется версия 4.0.0 LERC библиотеки.

#### STB Image Write
`stb_image_write.h` — это заголовочная библиотека для записи изображений в различные форматы (PNG, BMP, TGA, JPEG, HDR). В расширении используется функция `stbi_write_png_to_mem()` для создания PNG данных в памяти.

### Архитектура решения

#### Основная функция
```cpp
extern "C" VALUE lerc_to_mapbox_png(VALUE /*self*/, VALUE lerc_data)
```

Функция принимает Ruby строку с LERC-данными и возвращает Ruby строку с PNG-данными.

#### Алгоритм работы

1. **Валидация входных данных**
   - Проверка типа и размера входных данных
   - Валидация через `Check_Type()` Ruby API

2. **Получение метаданных LERC**
   - Извлечение размеров изображения (ширина, высота, каналы)
   - Проверка типа данных (ожидается float)
   - Валидация размеров через `lerc_getBlobInfo()`

3. **Декодирование LERC**
   - Выделение памяти для данных высот
   - Декодирование через `lerc_decode()`
   - Обработка ошибок декодирования

4. **Конвертация в RGB**
   - Применение формулы Mapbox Terrain-RGB
   - Обработка специального случая 257×257 тайлов (обрезание до 256×256)
   - Использование `std::clamp()` для ограничения значений

   **C++ реализация:**
   ```cpp
   // Вычисление целочисленного кода: code = round((elevation + 10000) × 10)
   const int32_t code = std::clamp(
       static_cast<int32_t>((e + MAPBOX_OFFSET) / MAPBOX_SCALE), 0, MAX_24BIT);
   
   // Разложение на байты (побитовые операции):
   *rgb_ptr++ = static_cast<std::uint8_t>((code >> 16) & 0xFF);  // R = floor(code / 256²)
   *rgb_ptr++ = static_cast<std::uint8_t>((code >> 8)  & 0xFF);  // G = floor((code - R×256²) / 256)
   *rgb_ptr++ = static_cast<std::uint8_t>( code        & 0xFF);  // B = code - R×256² - G×256
   ```

5. **Создание PNG**
   - Генерация PNG данных через STB Image Write
   - Использование RAII для управления памятью
   - Возврат результата в Ruby

#### Управление памятью

Расширение использует современные C++ подходы для безопасного управления памятью:

- `std::vector` для динамических массивов
- `std::unique_ptr` с кастомным deleter для PNG данных
- RAII принципы для автоматической очистки ресурсов
- Предварительная аллокация памяти для оптимизации производительности

#### Обработка ошибок

Реализована многоуровневая система обработки ошибок:

- Проверка входных параметров
- Валидация LERC метаданных
- Обработка ошибок декодирования
- C++ исключения с переводом в Ruby исключения
- Детальные сообщения об ошибках

## Интеграция

### Ruby API
```ruby
# Модуль LercFFI предоставляет метод:
LercFFI.lerc_to_mapbox_png(lerc_data) # => png_data
```

### Использование в сервисе
Расширение интегрировано в основной сервис кэширования тайлов (`config.ru`) и автоматически применяется для обработки LERC-данных от ArcGIS сервисов.

## Производительность

### Оптимизации
- Предварительная аллокация памяти (`reserve()`)
- Прямая арифметика указателей в критических циклах
- Агрессивные флаги компилятора (`-O3`, `-march=native`, `-flto`)
- Отключение RTTI для уменьшения размера

### Ограничения
- Поддерживается только тип данных float
- Максимальное значение высоты ограничено 24-битным диапазоном
- Обработка только одноканальных данных рельефа

## Сборка

Расширение собирается через стандартный Ruby механизм `mkmf` с использованием `extconf.rb`. Требует установленной LERC библиотеки в системе.

### Зависимости
- Ruby 3.4+
- LERC 4.0.0
- STB Image Write (заголовочная библиотека)
- C++23 совместимый компилятор
